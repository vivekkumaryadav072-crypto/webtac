import React, { useEffect, useState } from "react";

/*
Single-file React prototype for: Electrician Finder Marketplace
- Customer sign-up/login (phone/email/name) with simulated OTP
- Electrician registration
- Search electricians by service & location
- Booking flow (store in localStorage)
- Star ratings & reviews
- Location access (browser geolocation) with manual fallback

Styling: Tailwind CSS classes (assumes Tailwind is configured in host project)
Instructions: Drop this component into a create-react-app / Vite React project and ensure Tailwind is enabled.

This is a prototype using localStorage as the backend. Replace localStorage calls with real API endpoints in production.
*/

const SERVICES = [
  "AC Repair",
  "Washing Machine",
  "Refrigerator",
  "TV Setup",
  "Wiring/Points",
  "Inverter/UPS",
  "Geyser/Heater",
  "Electrical Inspection",
];

// Utilities
const uid = () => Math.random().toString(36).slice(2, 9);

// LocalStorage keys
const LS = {
  USERS: "ef_users",
  ELECTRICIANS: "ef_electricians",
  BOOKINGS: "ef_bookings",
};

// Initialize storage if empty
const ensureStorage = () => {
  if (!localStorage.getItem(LS.USERS)) localStorage.setItem(LS.USERS, JSON.stringify([]));
  if (!localStorage.getItem(LS.ELECTRICIANS)) localStorage.setItem(LS.ELECTRICIANS, JSON.stringify([]));
  if (!localStorage.getItem(LS.BOOKINGS)) localStorage.setItem(LS.BOOKINGS, JSON.stringify([]));
};

function save(key, val) {
  localStorage.setItem(key, JSON.stringify(val));
}
function load(key) {
  const v = localStorage.getItem(key);
  return v ? JSON.parse(v) : null;
}

// Rating component
function StarRating({ value = 0, onChange }) {
  const [hover, setHover] = useState(0);
  return (
    <div className="flex gap-1">
      {[1, 2, 3, 4, 5].map((n) => (
        <button
          key={n}
          onMouseEnter={() => setHover(n)}
          onMouseLeave={() => setHover(0)}
          onClick={() => onChange && onChange(n)}
          className={`text-2xl ${n <= (hover || value) ? "text-yellow-400" : "text-gray-300"}`}
          aria-label={`Rate ${n}`}
        >
          ★
        </button>
      ))}
    </div>
  );
}

// Main App
export default function App() {
  ensureStorage();

  const [user, setUser] = useState(null); // {id, name, email, phone}
  const [view, setView] = useState("home");
  const [query, setQuery] = useState("");
  const [serviceFilter, setServiceFilter] = useState("");
  const [location, setLocation] = useState(null); // {lat, lng, text}
  const [electricians, setElectricians] = useState(load(LS.ELECTRICIANS) || []);
  const [bookings, setBookings] = useState(load(LS.BOOKINGS) || []);
  const [users, setUsers] = useState(load(LS.USERS) || []);

  useEffect(() => {
    setElectricians(load(LS.ELECTRICIANS) || []);
    setBookings(load(LS.BOOKINGS) || []);
    setUsers(load(LS.USERS) || []);
  }, []);

  useEffect(() => save(LS.ELECTRICIANS, electricians), [electricians]);
  useEffect(() => save(LS.BOOKINGS, bookings), [bookings]);
  useEffect(() => save(LS.USERS, users), [users]);

  // Location access helper
  const requestLocation = () => {
    if (!navigator.geolocation) return alert("Geolocation not supported in this browser.");
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude, text: "Current location" };
        setLocation(coords);
        alert("Location captured — use it in searches.");
      },
      (err) => {
        console.error(err);
        alert("Permission denied or error getting location. You can enter manually.");
      }
    );
  };

  // Basic search for electricians
  const searchResults = () => {
    const q = query.trim().toLowerCase();
    return electricians
      .filter((e) => (serviceFilter ? e.services?.includes(serviceFilter) : true))
      .filter((e) => (q ? (e.name || "").toLowerCase().includes(q) || (e.description || "").toLowerCase().includes(q) : true))
      .map((e) => ({
        ...e,
        avgRating: e.ratings && e.ratings.length ? e.ratings.reduce((a, b) => a + b.score, 0) / e.ratings.length : 0,
      }))
      .sort((a, b) => b.avgRating - a.avgRating);
  };

  // Auth flows (simulated OTP)
  const startLogin = ({ phone, email, name }) => {
    if (!phone && !email) return alert("Provide phone or email to continue.");
    // simulate OTP: always succeed
    const existing = users.find((u) => (phone && u.phone === phone) || (email && u.email === email));
    if (existing) {
      setUser(existing);
    } else {
      const newUser = { id: uid(), name: name || "", phone: phone || "", email: email || "" };
      setUsers((s) => [...s, newUser]);
      setUser(newUser);
    }
    setView("home");
  };

  // Electrician registration
  const registerElectrician = (data) => {
    const e = { id: uid(), ...data, ratings: [], createdAt: Date.now() };
    setElectricians((s) => [...s, e]);
    setView("electricians");
    alert("Electrician registered — visible in search results.");
  };

  // Booking
  const makeBooking = ({ electricianId, service, schedule, notes }) => {
    if (!user) return alert("Please login or signup to book.");
    const b = { id: uid(), electricianId, userId: user.id, service, schedule, notes, status: "requested", createdAt: Date.now() };
    setBookings((s) => [...s, b]);
    setView("bookings");
    alert("Booking requested. Electrician will respond (simulated).\nSee Bookings tab.");
  };

  // Add rating
  const addRating = ({ electricianId, score, comment }) => {
    setElectricians((list) =>
      list.map((e) => {
        if (e.id !== electricianId) return e;
        return { ...e, ratings: [...(e.ratings || []), { id: uid(), score, comment, by: user?.id || "guest", at: Date.now() }] };
      })
    );
    alert("Thanks for rating!");
  };

  // Simple UI components below
  const Header = () => (
    <header className="bg-indigo-600 text-white p-4 flex items-center justify-between">
      <div className="flex items-center gap-3">
        <div className="text-2xl">⚡</div>
        <div>
          <div className="font-bold">Electrician Finder</div>
          <div className="text-xs">Find trusted electricians near you</div>
        </div>
      </div>

      <nav className="flex items-center gap-3">
        <button onClick={() => setView("home")} className="px-3 py-1 rounded hover:bg-indigo-500">Home</button>
        <button onClick={() => setView("electricians")} className="px-3 py-1 rounded hover:bg-indigo-500">Electricians</button>
        <button onClick={() => setView("bookings")} className="px-3 py-1 rounded hover:bg-indigo-500">Bookings</button>
        <button onClick={() => setView("registerElectrician")} className="px-3 py-1 rounded hover:bg-indigo-500">Register</button>
        {user ? (
          <div className="flex items-center gap-2">
            <div className="text-sm">{user.name || user.phone || user.email}</div>
            <button
              onClick={() => {
                setUser(null);
                setView("home");
              }}
              className="bg-white text-indigo-600 px-2 py-1 rounded text-sm"
            >
              Logout
            </button>
          </div>
        ) : (
          <button onClick={() => setView("auth")} className="bg-white text-indigo-600 px-3 py-1 rounded">Login</button>
        )}
      </nav>
    </header>
  );

  const Home = () => (
    <div className="p-6">
      <div className="max-w-4xl mx-auto">
        <div className="grid md:grid-cols-2 gap-6">
          <div className="p-6 bg-white rounded shadow">
            <h2 className="text-xl font-semibold mb-3">Find an electrician near you</h2>
            <input value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Search by name or problem (e.g. 'AC not cooling')" className="w-full p-2 border rounded mb-3" />
            <select value={serviceFilter} onChange={(e) => setServiceFilter(e.target.value)} className="w-full p-2 border rounded mb-3">
              <option value="">All Services</option>
              {SERVICES.map((s) => (
                <option key={s} value={s}>{s}</option>
              ))}
            </select>

            <div className="flex gap-2">
              <button onClick={requestLocation} className="px-4 py-2 bg-indigo-600 text-white rounded">Use my location</button>
              <button onClick={() => setView("electricians")} className="px-4 py-2 border rounded">Search</button>
            </div>

            <div className="mt-4 text-sm text-gray-600">Tip: Allow location access for better nearby results.</div>
          </div>

          <div className="p-6 bg-white rounded shadow">
            <h3 className="text-lg font-semibold mb-2">Popular Services</h3>
            <div className="grid grid-cols-2 gap-3">
              {SERVICES.slice(0, 6).map((s) => (
                <button key={s} onClick={() => { setServiceFilter(s); setView("electricians"); }} className="p-3 border rounded text-sm text-center">{s}</button>
              ))}
            </div>

            <div className="mt-4">
              <h4 className="font-semibold">Why choose certified electricians?</h4>
              <ul className="list-disc pl-5 text-sm text-gray-700">
                <li>Safety-first repairs & compliance checks</li>
                <li>Transparent pricing & ratings</li>
                <li>Book and track services from your phone</li>
              </ul>
            </div>
          </div>
        </div>

        <div className="mt-6">
          <h3 className="text-xl font-semibold mb-3">Top Rated</h3>
          <div className="grid md:grid-cols-3 gap-4">
            {searchResults().slice(0, 6).map((e) => (
              <ElectricianCard key={e.id} e={e} onBook={() => setView(`book:${e.id}`)} onRate={() => setView(`rate:${e.id}`)} />
            ))}
            {searchResults().length === 0 && <div className="text-gray-500">No electricians found. Register one!</div>}
          </div>
        </div>
      </div>
    </div>
  );

  function ElectricianCard({ e, onBook, onRate }) {
    return (
      <div className="p-4 bg-white rounded shadow">
        <div className="flex items-center justify-between mb-2">
          <div>
            <div className="font-semibold">{e.name}</div>
            <div className="text-sm text-gray-600">{e.experience ? `${e.experience} yrs experience` : "Experience not set"}</div>
          </div>
          <div className="text-sm">
            <div className="text-xs">Avg</div>
            <div className="font-bold">{(e.avgRating || 0).toFixed(1)}</div>
          </div>
        </div>
        <div className="text-sm text-gray-700 mb-2">{e.description}</div>
        <div className="flex gap-2">
          <button onClick={onBook} className="px-3 py-1 bg-indigo-600 text-white rounded text-sm">Book</button>
          <button onClick={onRate} className="px-3 py-1 border rounded text-sm">Rate</button>
        </div>
      </div>
    );
  }

  const ElectriciansList = () => (
    <div className="p-6 max-w-4xl mx-auto">
      <h2 className="text-xl font-semibold mb-4">Electricians</h2>
      <div className="grid md:grid-cols-2 gap-4">
        {searchResults().map((e) => (
          <div key={e.id} className="p-4 bg-white rounded shadow">
            <div className="flex justify-between items-start">
              <div>
                <div className="font-semibold">{e.name}</div>
                <div className="text-sm text-gray-600">Services: {e.services?.join(", ")}</div>
                <div className="text-sm text-gray-600">Charges: {e.charges ? `₹ ${e.charges}` : "Not set"}</div>
              </div>
              <div className="text-right">
                <div className="text-sm text-gray-500">{(e.avgRating || 0).toFixed(1)} ★</div>
                <div className="text-xs text-gray-400">{(e.ratings?.length || 0)} reviews</div>
              </div>
            </div>

            <p className="mt-2 text-sm text-gray-700">{e.description}</p>

            <div className="mt-3 flex gap-2">
              <button onClick={() => setView(`book:${e.id}`)} className="px-3 py-1 bg-indigo-600 text-white rounded">Book</button>
              <button onClick={() => setView(`rate:${e.id}`)} className="px-3 py-1 border rounded">Rate</button>
            </div>
          </div>
        ))}

        {searchResults().length === 0 && <div className="text-gray-500">No electricians match your filters.</div>}
      </div>
    </div>
  );

  const Auth = () => {
    const [phone, setPhone] = useState("");
    const [email, setEmail] = useState("");
    const [name, setName] = useState("");

    return (
      <div className="p-6 max-w-md mx-auto">
        <h2 className="text-xl font-semibold mb-4">Login / Signup</h2>
        <div className="bg-white p-4 rounded shadow">
          <label className="text-sm">Full name</label>
          <input value={name} onChange={(e) => setName(e.target.value)} className="w-full p-2 border rounded mb-3" />

          <label className="text-sm">Phone number</label>
          <input value={phone} onChange={(e) => setPhone(e.target.value)} className="w-full p-2 border rounded mb-3" placeholder="Optional but recommended" />

          <label className="text-sm">Email</label>
          <input value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-2 border rounded mb-3" placeholder="Optional" />

          <div className="flex gap-2">
            <button
              onClick={() => startLogin({ phone, email, name })}
              className="px-4 py-2 bg-indigo-600 text-white rounded"
            >
              Continue (Simulated OTP)
            </button>
            <button onClick={() => { setView("home"); }} className="px-4 py-2 border rounded">Cancel</button>
          </div>
        </div>
      </div>
    );
  };

  const RegisterElectrician = () => {
    const [name, setName] = useState("");
    const [phone, setPhone] = useState("");
    const [services, setServices] = useState([]);
    const [charges, setCharges] = useState("");
    const [experience, setExperience] = useState("");
    const [desc, setDesc] = useState("");

    const toggleService = (s) => setServices((prev) => (prev.includes(s) ? prev.filter((x) => x !== s) : [...prev, s]));

    return (
      <div className="p-6 max-w-2xl mx-auto">
        <h2 className="text-xl font-semibold mb-4">Register as Electrician</h2>
        <div className="bg-white p-4 rounded shadow">
          <label className="text-sm">Name</label>
          <input value={name} onChange={(e) => setName(e.target.value)} className="w-full p-2 border rounded mb-3" />

          <label className="text-sm">Phone</label>
          <input value={phone} onChange={(e) => setPhone(e.target.value)} className="w-full p-2 border rounded mb-3" />

          <label className="text-sm">Services (select)</label>
          <div className="grid grid-cols-2 gap-2 mb-3">
            {SERVICES.map((s) => (
              <button key={s} onClick={() => toggleService(s)} className={`p-2 border rounded text-sm ${services.includes(s) ? "bg-indigo-600 text-white" : ""}`}>{s}</button>
            ))}
          </div>

          <label className="text-sm">Charges (approx per visit ₹)</label>
          <input value={charges} onChange={(e) => setCharges(e.target.value)} className="w-full p-2 border rounded mb-3" />

          <label className="text-sm">Years of Experience</label>
          <input value={experience} onChange={(e) => setExperience(e.target.value)} className="w-full p-2 border rounded mb-3" />

          <label className="text-sm">Short description</label>
          <textarea value={desc} onChange={(e) => setDesc(e.target.value)} className="w-full p-2 border rounded mb-3" />

          <div className="flex gap-2">
            <button onClick={() => registerElectrician({ name, phone, services, charges, experience, description: desc })} className="px-4 py-2 bg-indigo-600 text-white rounded">Register</button>
            <button onClick={() => setView("home")} className="px-4 py-2 border rounded">Cancel</button>
          </div>
        </div>
      </div>
    );
  };

  const BookingForm = ({ electrician }) => {
    const [schedule, setSchedule] = useState("");
    const [service, setService] = useState(electrician.services?.[0] || "");
    const [notes, setNotes] = useState("");

    return (
      <div className="p-6 max-w-md mx-auto">
        <h3 className="text-lg font-semibold">Book {electrician.name}</h3>
        <div className="bg-white p-4 rounded shadow">
          <label className="text-sm">Service</label>
          <select value={service} onChange={(e) => setService(e.target.value)} className="w-full p-2 border rounded mb-3">
            {electrician.services?.map((s) => <option key={s} value={s}>{s}</option>)}
          </select>

          <label className="text-sm">Preferred date & time</label>
          <input value={schedule} onChange={(e) => setSchedule(e.target.value)} placeholder="e.g. 2025-09-18 10:00" className="w-full p-2 border rounded mb-3" />

          <label className="text-sm">Notes</label>
          <textarea value={notes} onChange={(e) => setNotes(e.target.value)} className="w-full p-2 border rounded mb-3" />

          <div className="flex gap-2">
            <button onClick={() => makeBooking({ electricianId: electrician.id, service, schedule, notes })} className="px-4 py-2 bg-indigo-600 text-white rounded">Request</button>
            <button onClick={() => setView("electricians")} className="px-4 py-2 border rounded">Cancel</button>
          </div>
        </div>
      </div>
    );
  };

  const RatingForm = ({ electrician }) => {
    const [score, setScore] = useState(5);
    const [comment, setComment] = useState("");
    return (
      <div className="p-6 max-w-md mx-auto">
        <h3 className="text-lg font-semibold">Rate {electrician.name}</h3>
        <div className="bg-white p-4 rounded shadow">
          <div className="mb-2">Your rating</div>
          <StarRating value={score} onChange={(v) => setScore(v)} />
          <textarea value={comment} onChange={(e) => setComment(e.target.value)} className="w-full p-2 border rounded mt-3" placeholder="Write feedback (optional)" />
          <div className="flex gap-2 mt-3">
            <button onClick={() => { addRating({ electricianId: electrician.id, score, comment }); setView("electricians"); }} className="px-4 py-2 bg-indigo-600 text-white rounded">Submit</button>
            <button onClick={() => setView("electricians")} className="px-4 py-2 border rounded">Cancel</button>
          </div>
        </div>
      </div>
    );
  };

  const BookingsView = () => {
    const my = bookings.filter((b) => user && b.userId === user.id);
    return (
      <div className="p-6 max-w-4xl mx-auto">
        <h2 className="text-xl font-semibold mb-4">My Bookings</h2>
        {!user && <div className="text-gray-500">Login to see your bookings.</div>}
        {user && my.length === 0 && <div className="text-gray-500">No bookings yet. Book an electrician from the Electricians page.</div>}

        <div className="grid gap-4">
          {my.map((b) => {
            const e = electricians.find((x) => x.id === b.electricianId) || { name: "Unknown" };
            return (
              <div key={b.id} className="p-4 bg-white rounded shadow flex justify-between">
                <div>
                  <div className="font-semibold">{e.name}</div>
                  <div className="text-sm text-gray-600">{b.service} • {b.schedule || "No schedule"}</div>
                  <div className="text-xs text-gray-500">Status: {b.status}</div>
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={() => setView(`rate:${e.id}`)} className="px-3 py-1 border rounded">Rate</button>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  // Router-ish: parse view strings like 'book:<id>' or 'rate:<id>'
  const renderView = () => {
    if (view.startsWith("book:")) {
      const id = view.split(":")[1];
      const e = electricians.find((x) => x.id === id);
      if (!e) return <div className="p-6">Electrician not found.</div>;
      return <BookingForm electrician={e} />;
    }
    if (view.startsWith("rate:")) {
      const id = view.split(":")[1];
      const e = electricians.find((x) => x.id === id);
      if (!e) return <div className="p-6">Electrician not found.</div>;
      return <RatingForm electrician={e} />;
    }

    switch (view) {
      case "home":
        return <Home />;
      case "electricians":
        return <ElectriciansList />;
      case "auth":
        return <Auth />;
      case "registerElectrician":
        return <RegisterElectrician />;
      case "bookings":
        return <BookingsView />;
      default:
        return <Home />;
    }
  };

  return (
    <div className="min-h-screen bg-gray-100">
      <Header />
      {renderView()}

      <footer className="text-center text-sm text-gray-600 p-4">Prototype — replace localStorage logic with real backend for production.</footer>
    </div>
  );
}
